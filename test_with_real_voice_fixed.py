#!/usr/bin/env python3
"""
Teste com arquivo de voz real - VERS√ÉO CORRIGIDA
Identifica se o problema est√° na clonagem ou na convers√£o texto-para-√°udio
"""

import os
import sys
import logging
import warnings
import glob
import time
import base64
from pathlib import Path

# Configurar logging detalhado
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def find_voice_files():
    """Encontra arquivos de voz na pasta especificada"""
    
    # Usar Path para evitar problemas de escape
    voice_folder = Path("C:/Users/gloli/Downloads/Vozes para TTS Coqui")
    
    logger.info(f"üîç Procurando arquivos de voz em: {voice_folder}")
    
    if not voice_folder.exists():
        logger.error(f"‚ùå Pasta n√£o encontrada: {voice_folder}")
        return []
    
    # Procurar arquivos de √°udio
    audio_extensions = ['*.wav', '*.mp3', '*.flac', '*.m4a', '*.ogg']
    voice_files = []
    
    for ext in audio_extensions:
        files = list(voice_folder.glob(ext))
        voice_files.extend([str(f) for f in files])
    
    # Filtrar apenas arquivos v√°lidos
    valid_files = []
    for file_path in voice_files:
        if os.path.exists(file_path) and os.path.getsize(file_path) > 1000:  # Pelo menos 1KB
            file_size = os.path.getsize(file_path)
            logger.info(f"üìÅ Encontrado: {os.path.basename(file_path)} ({file_size} bytes)")
            valid_files.append(file_path)
    
    logger.info(f"‚úÖ {len(valid_files)} arquivo(s) de voz v√°lido(s) encontrado(s)")
    return valid_files

def copy_voice_to_reference(voice_file):
    """Copia arquivo de voz para pasta reference_audio"""
    
    if not voice_file or not os.path.exists(voice_file):
        logger.error("‚ùå Arquivo de voz inv√°lido")
        return None
    
    # Criar pasta reference_audio se n√£o existir
    ref_dir = "reference_audio"
    os.makedirs(ref_dir, exist_ok=True)
    
    # Nome do arquivo de destino
    filename = os.path.basename(voice_file)
    name, ext = os.path.splitext(filename)
    dest_file = os.path.join(ref_dir, f"real_voice_test{ext}")
    
    try:
        import shutil
        shutil.copy2(voice_file, dest_file)
        
        if os.path.exists(dest_file):
            file_size = os.path.getsize(dest_file)
            logger.info(f"‚úÖ Arquivo copiado: {dest_file} ({file_size} bytes)")
            return dest_file
        else:
            logger.error("‚ùå Falha ao copiar arquivo")
            return None
            
    except Exception as e:
        logger.error(f"‚ùå Erro ao copiar arquivo: {e}")
        return None

def test_xtts_v2_with_real_voice(reference_file):
    """Testa XTTS v2 com arquivo de voz real"""
    
    logger.info("üß™ TESTE COM ARQUIVO DE VOZ REAL")
    logger.info("=" * 60)
    
    # Configurar ambiente
    logger.info("üîß Configurando ambiente...")
    warnings.filterwarnings("ignore")
    os.environ["COQUI_TOS_AGREED"] = "1"
    os.environ["COQUI_TTS_AGREED"] = "1"
    os.environ["COQUI_TTS_NO_MECAB"] = "1"
    os.environ["PYTHONIOENCODING"] = "utf-8"
    
    # Teste 1: Carregar XTTS v2
    logger.info("üîÑ TESTE 1: Carregando XTTS v2...")
    try:
        from TTS.api import TTS
        logger.info("‚úÖ TTS.api importado")
        
        tts = TTS("tts_models/multilingual/multi-dataset/xtts_v2", gpu=False)
        logger.info("‚úÖ XTTS v2 carregado")
        
        if not hasattr(tts, 'tts_to_file'):
            logger.error("‚ùå M√©todo tts_to_file n√£o encontrado")
            return False
            
        logger.info("‚úÖ M√©todo tts_to_file dispon√≠vel")
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao carregar XTTS v2: {e}")
        return False
    
    # Teste 2: Verificar arquivo de refer√™ncia
    logger.info("üîÑ TESTE 2: Verificando arquivo de refer√™ncia...")
    if not reference_file or not os.path.exists(reference_file):
        logger.error("‚ùå Arquivo de refer√™ncia n√£o encontrado")
        return False
    
    file_size = os.path.getsize(reference_file)
    logger.info(f"‚úÖ Arquivo de refer√™ncia v√°lido: {file_size} bytes")
    
    # Teste 3: S√≠ntese simples (sem clonagem)
    logger.info("üîÑ TESTE 3: S√≠ntese simples (sem clonagem)...")
    try:
        simple_text = "Teste de s√≠ntese simples sem clonagem de voz."
        simple_output = "test_simple_synthesis.wav"
        
        logger.info(f"üìù Texto: {simple_text}")
        logger.info(f"üìÅ Sa√≠da: {simple_output}")
        
        # S√≠ntese sem clonagem (usando voz padr√£o)
        tts.tts_to_file(
            text=simple_text,
            file_path=simple_output,
            language="pt"
        )
        
        # Aguardar arquivo
        for i in range(30):
            if os.path.exists(simple_output) and os.path.getsize(simple_output) > 0:
                file_size = os.path.getsize(simple_output)
                logger.info(f"‚úÖ S√≠ntese simples funcionou! ({file_size} bytes)")
                break
            time.sleep(1)
        else:
            logger.error("‚ùå S√≠ntese simples falhou - arquivo n√£o gerado")
            return False
            
    except Exception as e:
        logger.error(f"‚ùå Erro na s√≠ntese simples: {e}")
        return False
    
    # Teste 4: Clonagem de voz com arquivo real
    logger.info("üîÑ TESTE 4: Clonagem de voz com arquivo real...")
    try:
        clone_text = "Este √© um teste de clonagem de voz usando um arquivo real da pasta de vozes."
        clone_output = "test_voice_cloning_real.wav"
        
        logger.info(f"üìù Texto: {clone_text}")
        logger.info(f"üéµ Refer√™ncia: {reference_file}")
        logger.info(f"üìÅ Sa√≠da: {clone_output}")
        
        # Clonagem com arquivo real
        logger.info("   üîÑ Executando clonagem...")
        tts.tts_to_file(
            text=clone_text,
            file_path=clone_output,
            speaker_wav=reference_file,
            language="pt"
        )
        
        # Aguardar arquivo
        logger.info("   ‚è≥ Aguardando arquivo ser gerado...")
        for i in range(60):  # 60 segundos para clonagem
            if os.path.exists(clone_output) and os.path.getsize(clone_output) > 0:
                file_size = os.path.getsize(clone_output)
                logger.info(f"‚úÖ Clonagem funcionou ap√≥s {i+1}s! ({file_size} bytes)")
                
                # Teste de convers√£o base64
                try:
                    with open(clone_output, 'rb') as f:
                        audio_data = f.read()
                    audio_base64 = base64.b64encode(audio_data).decode('utf-8')
                    logger.info(f"‚úÖ Convers√£o base64 OK ({len(audio_base64)} chars)")
                    return True
                except Exception as b64_error:
                    logger.error(f"‚ùå Erro na convers√£o base64: {b64_error}")
                    return False
                    
            if i % 10 == 0:  # Log a cada 10 segundos
                logger.info(f"   ‚è≥ Aguardando... {i}s")
            time.sleep(1)
        
        logger.error("‚ùå Clonagem falhou - arquivo n√£o gerado em 60s")
        return False
        
    except Exception as e:
        logger.error(f"‚ùå Erro na clonagem: {e}")
        logger.error(f"   Tipo do erro: {type(e).__name__}")
        
        # Log detalhado do erro
        error_str = str(e).lower()
        if "mecab" in error_str:
            logger.error("üîç Erro relacionado ao MeCab")
        elif "speaker" in error_str:
            logger.error("üîç Erro relacionado ao speaker/refer√™ncia")
        elif "memory" in error_str:
            logger.error("üîç Erro de mem√≥ria")
        elif "cuda" in error_str or "gpu" in error_str:
            logger.error("üîç Erro de GPU/CUDA")
        else:
            logger.error("üîç Erro desconhecido")
            
        return False

def test_server_integration(reference_file):
    """Testa integra√ß√£o com o servidor"""
    
    logger.info("üîÑ TESTE 5: Integra√ß√£o com servidor...")
    
    try:
        import requests
        base_url = "http://localhost:8001"
        
        # Verificar se servidor est√° rodando
        try:
            response = requests.get(f"{base_url}/health", timeout=5)
            if response.status_code != 200:
                logger.warning("‚ö†Ô∏è Servidor n√£o est√° rodando - pule este teste")
                return True  # N√£o √© erro cr√≠tico
        except:
            logger.warning("‚ö†Ô∏è Servidor n√£o est√° rodando - pule este teste")
            return True
        
        logger.info("‚úÖ Servidor est√° rodando")
        
        # Testar clonagem via API
        payload = {
            "text": "Teste de clonagem via API do servidor com arquivo real.",
            "language": "pt"
        }
        
        response = requests.post(
            f"{base_url}/api/tts/clone-voice",
            json=payload,
            timeout=120
        )
        
        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                audio_b64 = data.get("audio_base64", "")
                engine = data.get("engine", "unknown")
                logger.info(f"‚úÖ API funcionou! Engine: {engine}, √Åudio: {len(audio_b64)} chars")
                return True
            else:
                error = data.get("error", "Erro desconhecido")
                logger.error(f"‚ùå API falhou: {error}")
                return False
        else:
            logger.error(f"‚ùå API retornou status: {response.status_code}")
            return False
            
    except Exception as e:
        logger.error(f"‚ùå Erro na integra√ß√£o com servidor: {e}")
        return False

def main():
    """Fun√ß√£o principal"""
    logger.info("üß™ TESTE COM ARQUIVO DE VOZ REAL")
    logger.info("Identifica se problema est√° na clonagem ou convers√£o texto-para-√°udio")
    logger.info("=" * 80)
    
    # Encontrar arquivos de voz
    voice_files = find_voice_files()
    if not voice_files:
        logger.error("‚ùå Nenhum arquivo de voz encontrado")
        logger.error("üí° Verifique se a pasta existe: C:/Users/gloli/Downloads/Vozes para TTS Coqui")
        return
    
    # Usar o primeiro arquivo encontrado
    voice_file = voice_files[0]
    logger.info(f"üéµ Usando arquivo: {os.path.basename(voice_file)}")
    
    # Copiar para pasta reference_audio
    reference_file = copy_voice_to_reference(voice_file)
    if not reference_file:
        logger.error("‚ùå Falha ao preparar arquivo de refer√™ncia")
        return
    
    # Executar testes
    tests_passed = 0
    total_tests = 2
    
    if test_xtts_v2_with_real_voice(reference_file):
        tests_passed += 1
        logger.info("‚úÖ TESTE DIRETO PASSOU")
    else:
        logger.error("‚ùå TESTE DIRETO FALHOU")
    
    if test_server_integration(reference_file):
        tests_passed += 1
        logger.info("‚úÖ TESTE SERVIDOR PASSOU")
    else:
        logger.error("‚ùå TESTE SERVIDOR FALHOU")
    
    # Resultado final
    logger.info("=" * 80)
    logger.info("üìä RESULTADO FINAL")
    logger.info("=" * 80)
    
    if tests_passed == total_tests:
        logger.info("üéâ TODOS OS TESTES PASSARAM!")
        logger.info("‚úÖ XTTS v2 funciona com arquivo real")
        logger.info("‚úÖ Clonagem de voz funciona")
        logger.info("‚úÖ Convers√£o texto-para-√°udio funciona")
        logger.info("‚úÖ Integra√ß√£o com servidor funciona")
        
        print("\nüéØ DIAGN√ìSTICO:")
        print("‚úÖ Sistema est√° funcionando corretamente")
        print("‚úÖ Problema pode estar em outro lugar")
        print("üí° Verifique configura√ß√£o do cliente/interface")
        
    elif tests_passed == 1:
        logger.warning("‚ö†Ô∏è TESTE PARCIAL")
        logger.info("‚úÖ XTTS v2 funciona diretamente")
        logger.error("‚ùå Integra√ß√£o com servidor falha")
        
        print("\nüîç DIAGN√ìSTICO:")
        print("‚úÖ XTTS v2 funciona (n√£o √© problema do engine)")
        print("‚ùå Problema est√° na integra√ß√£o do servidor")
        print("üí° Verifique endpoints da API")
        print("üí° Verifique logs do servidor")
        
    else:
        logger.error("‚ùå TODOS OS TESTES FALHARAM")
        logger.error("‚ùå XTTS v2 n√£o funciona nem diretamente")
        
        print("\nüîç DIAGN√ìSTICO:")
        print("‚ùå Problema fundamental no XTTS v2")
        print("üí° Verifique instala√ß√£o do TTS")
        print("üí° Verifique depend√™ncias")
        print("üí° Verifique configura√ß√£o do ambiente")

if __name__ == "__main__":
    main()