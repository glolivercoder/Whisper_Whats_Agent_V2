<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Voice Agent V2 Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 0;
            max-width: 1200px;
            width: 100%;
            min-height: 700px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: linear-gradient(135deg, #25D366, #128C7E);
            display: flex;
            border-radius: 20px 20px 0 0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab-button.active {
            background: white;
            color: #25D366;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #25D366;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Header and Status */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #25D366;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .service-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }
        .status-dot.healthy { background: #28a745; }
        .status-dot.loading { background: #ffc107; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Configuration Grids */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #25D366;
        }

        .config-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }

        /* Monitoring Styles */
        .monitoring-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .monitor-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .service-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .service-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .service-details {
            margin-left: auto;
            font-size: 12px;
            color: #6c757d;
        }

        .links-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .link-btn {
            padding: 10px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .link-btn:hover {
            background: #128C7E;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #25D366;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Voice Cloning Styles */
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f0f8f0;
            border-left: 3px solid #25D366;
            font-size: 12px;
        }

        .query-result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Quick Status Panel */
        .quick-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #25D366;
        }

        .quick-status h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .controls-panel {
            grid-area: controls;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            overflow-y: auto;
        }

        .controls-panel h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 14px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 12px;
            color: #6c757d;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 12px;
        }

        .chat-area {
            grid-area: chat;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 1px solid #dee2e6;
        }
        
        .message.transcribing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .message.system {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            font-style: italic;
            text-align: center;
        }
        
        .transcription-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .temporary-message {
            opacity: 0.9;
            font-style: italic;
        }

        .message-meta {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* TTS Audio Player Styles */
        .tts-audio-player {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
            font-size: 11px;
        }

        .audio-play-btn,
        .audio-stop-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-play-btn:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }

        .audio-stop-btn:hover {
            background: #f8d7da;
            transform: scale(1.1);
        }

        .tts-status {
            color: #6c757d;
            font-size: 10px;
            margin-left: auto;
        }

        .tts-status.playing {
            color: #28a745;
            font-weight: 500;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .record-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .record-button:hover { transform: scale(1.05); }
        .record-button.recording {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            animation: recording-pulse 1s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .message-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            min-height: 50px;
            max-height: 100px;
        }

        .send-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .status-panel {
            grid-area: status;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            overflow-y: auto;
        }

        .status-panel h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 14px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .info-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }

        .info-label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .info-value {
            font-size: 12px;
            color: #333;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .btn-small {
            flex: 1;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-small:hover { background: #e9ecef; }

        .footer {
            grid-area: footer;
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        /* CSS for new interface elements */
        .response-mode-switch {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .response-mode-switch label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .stop-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stop-button:hover {
            transform: scale(1.05);
        }

        .audio-test-area {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 15px;
        }

        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #25D366;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 12px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            background: #128C7E;
            transform: translateY(-1px);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-areas: 
                    "header"
                    "chat"
                    "controls"
                    "status"
                    "footer";
                grid-template-columns: 1fr;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('chat')">üí¨ Chat</button>
            <button class="tab-button" onclick="switchTab('history')">üìú Hist√≥rico</button>
            <button class="tab-button" onclick="switchTab('llm')">üß† LLM Config</button>
            <button class="tab-button" onclick="switchTab('tts')">üîä TTS & Voice</button>
            <button class="tab-button" onclick="switchTab('database')">üíæ Database</button>
            <button class="tab-button" onclick="switchTab('whatsapp')">üì± WhatsApp</button>
            <button class="tab-button" onclick="switchTab('monitoring')">üìä Monitoring</button>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content active">
            <div class="header">
                <h1>ü§ñ WhatsApp Voice Agent V2 Enhanced</h1>
                <div class="status-bar">
                    <div class="service-status">
                        <div class="status-dot" id="stt-status"></div>
                        <span>STT</span>
                    </div>
                    <div class="service-status">
                        <div class="status-dot" id="llm-status"></div>
                        <span>LLM</span>
                    </div>
                    <div class="service-status">
                        <div class="status-dot" id="tts-status"></div>
                        <span>TTS</span>
                    </div>
                    <div class="service-status">
                        <div class="status-dot" id="db-status"></div>
                        <span>DB</span>
                    </div>
                    <div class="service-status">
                        <div class="status-dot" id="ws-status"></div>
                        <span>WebSocket</span>
                    </div>
                    <div id="status-text" style="margin-left: 20px; color: #666; font-size: 14px;">Sistema pronto!</div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="chat-interface" style="display: flex; flex-direction: column; height: 600px; gap: 15px;">
                
                <!-- Voice Control Panel -->
                <div class="voice-controls" style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                    <h3>üé§ Controles de Voz</h3>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <button class="record-button" id="record-btn" onclick="toggleRecording()" style="font-size: 24px; padding: 15px 20px; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer;">üé§ Gravar</button>
                        <button class="stop-button" id="stop-btn" onclick="stopRecording()" style="font-size: 24px; padding: 15px 20px; background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; display: none;">‚èπÔ∏è Parar</button>
                        <div class="response-mode-switch" style="display: flex; gap: 10px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="radio" name="response-mode" value="tts" checked> üîä Resposta TTS
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="radio" name="response-mode" value="text"> üí¨ Apenas Texto
                            </label>
                        </div>
                        <div class="tts-default-selector" style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: bold; color: #495057;">üéõÔ∏è TTS Padr√£o:</label>
                            <select id="default-tts-engine" onchange="updateDefaultTTS()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 14px;">
                                <option value="gtts" selected>üåê Google TTS (Flash) - Padr√£o</option>
                                <option value="coqui">üé≠ Coqui TTS + Vozes Clonadas</option>
                                <option value="pyttsx3">üíª pyttsx3 (Offline)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-container" style="display: flex; gap: 20px; flex: 1;">
                    <div class="chat-area" style="flex: 1; display: flex; flex-direction: column; background: white; border: 1px solid #ddd; border-radius: 10px;">
                        <div class="chat-header" style="background: #007bff; color: white; padding: 15px; border-radius: 10px 10px 0 0;">
                            <h4>ü§ñ Conversa com o Agente</h4>
                        </div>
                        <div class="chat-messages" id="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; min-height: 300px; max-height: 400px;">
                            <div class="message assistant">
                                <div>ü§ñ Ol√°! Sou o assistente de voz enhanced com:</div>
                                <div>‚Ä¢ üé§ STT avan√ßado (Whisper)</div>
                                <div>‚Ä¢ üß† Multi-LLM (OpenRouter, Gemini)</div>
                                <div>‚Ä¢ üîä S√≠ntese de voz com Coqui TTS</div>
                                <div>‚Ä¢ üíæ Banco de dados integrado</div>
                                <div>‚Ä¢ üì± API WhatsApp completa</div>
                                <div class="message-meta">Sistema inicializado</div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div class="chat-input-area" style="padding: 15px; border-top: 1px solid #eee; background: #f8f9fa;">
                            <div class="input-controls" style="display: flex; gap: 10px; align-items: flex-end;">
                                <textarea id="message-input" class="message-input" placeholder="Digite sua mensagem ou use o microfone..." rows="2" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                                <button class="send-button" onclick="sendMessage()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; height: fit-content;">Enviar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Status Panel -->
                    <div class="quick-status" style="width: 280px; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
                        <h3>üìä Status R√°pido</h3>
                        <div class="info-item" style="margin: 10px 0; padding: 8px; background: white; border-radius: 5px;">
                            <div class="info-label" style="font-weight: bold; color: #666;">Sess√£o:</div>
                            <div class="info-value" id="session-id">-</div>
                        </div>
                        <div class="info-item" style="margin: 10px 0; padding: 8px; background: white; border-radius: 5px;">
                            <div class="info-label" style="font-weight: bold; color: #666;">Mensagens:</div>
                            <div class="info-value" id="message-count">0</div>
                        </div>
                        <div class="info-item" style="margin: 10px 0; padding: 8px; background: white; border-radius: 5px;">
                            <div class="info-label" style="font-weight: bold; color: #666;">√öltimo LLM:</div>
                            <div class="info-value" id="last-provider">-</div>
                        </div>
                        <div class="info-item" style="margin: 10px 0; padding: 8px; background: white; border-radius: 5px;">
                            <div class="info-label" style="font-weight: bold; color: #666;">Tempo Resposta:</div>
                            <div class="info-value" id="response-time">-</div>
                        </div>
                        <div class="btn-group" style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn-small" onclick="testServices()" style="flex: 1; padding: 8px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Testar</button>
                            <button class="btn-small" onclick="clearChat()" style="flex: 1; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Limpar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
            <div class="header">
                <h1>üìú Hist√≥rico de Conversas</h1>
                <div class="status-bar">
                    <div class="service-status">
                        <div class="status-dot healthy"></div>
                        <span>Hist√≥rico carregado</span>
                    </div>
                    <div id="history-stats" style="margin-left: 20px; color: #666; font-size: 14px;">0 conversas encontradas</div>
                </div>
            </div>
            
            <!-- History Interface -->
            <div class="history-interface" style="display: flex; flex-direction: column; height: 600px; gap: 15px;">
                
                <!-- History Controls -->
                <div class="history-controls" style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                    <h3>üîç Filtros e Controles</h3>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <div class="filter-group" style="display: flex; gap: 10px; align-items: center;">
                            <label>Data:</label>
                            <input type="date" id="date-filter" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                            <label>at√©:</label>
                            <input type="date" id="date-filter-end" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="filter-group" style="display: flex; gap: 10px; align-items: center;">
                            <label>Origem:</label>
                            <select id="source-filter" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Todas</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="web">Interface Web</option>
                                <option value="api">API</option>
                            </select>
                        </div>
                        <button class="btn-small" onclick="filterHistory()" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">üîç Filtrar</button>
                        <button class="btn-small" onclick="exportHistory()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">üì• Exportar</button>
                        <button class="btn-small" onclick="clearHistory()" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Limpar</button>
                    </div>
                </div>

                <!-- History List -->
                <div class="history-container" style="display: flex; gap: 20px; flex: 1;">
                    <div class="conversations-list" style="width: 300px; background: white; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <div class="conversations-header" style="background: #007bff; color: white; padding: 15px;">
                            <h4>üìã Lista de Conversas</h4>
                        </div>
                        <div class="conversations-items" id="conversations-list" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                            <div class="conversation-item empty" style="text-align: center; padding: 40px 20px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                                <div>Nenhuma conversa encontrada</div>
                                <div style="font-size: 12px; margin-top: 5px;">Inicie uma conversa para ver o hist√≥rico aqui</div>
                            </div>
                        </div>
                    </div>

                    <!-- Conversation Detail -->
                    <div class="conversation-detail" style="flex: 1; background: white; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <div class="detail-header" style="background: #28a745; color: white; padding: 15px;">
                            <h4 id="conversation-title">üìù Detalhes da Conversa</h4>
                        </div>
                        <div class="detail-content" id="conversation-detail" style="padding: 20px; max-height: 400px; overflow-y: auto;">
                            <div class="no-selection" style="text-align: center; padding: 60px 20px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üëà</div>
                                <div>Selecione uma conversa para ver os detalhes</div>
                                <div style="font-size: 12px; margin-top: 5px;">Clique em uma conversa da lista ao lado</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Stats -->
                <div class="history-stats" style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #ddd;">
                    <h4>üìä Estat√≠sticas do Hist√≥rico</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div class="stat-box" style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                            <div class="stat-number" id="total-conversations-stat" style="font-size: 24px; font-weight: bold; color: #007bff;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #666;">Total Conversas</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                            <div class="stat-number" id="total-messages-stat" style="font-size: 24px; font-weight: bold; color: #28a745;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #666;">Total Mensagens</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                            <div class="stat-number" id="avg-response-time" style="font-size: 24px; font-weight: bold; color: #ffc107;">0s</div>
                            <div class="stat-label" style="font-size: 12px; color: #666;">Tempo M√©dio</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                            <div class="stat-number" id="today-messages" style="font-size: 24px; font-weight: bold; color: #dc3545;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #666;">Hoje</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM Configuration Tab -->
        <div id="llm-tab" class="tab-content">
            <h2>üß† Configura√ß√£o LLM</h2>
            <div class="config-grid">
                <div class="config-section">
                    <h3>Provedor e Modelo</h3>
                    <div class="control-group">
                        <label for="llm-provider">Provedor LLM:</label>
                        <select id="llm-provider">
                            <option value="openrouter">OpenRouter</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="local">Local (Fallback)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="llm-model">Modelo:</label>
                        <select id="llm-model">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="max-tokens">M√°ximo de Tokens:</label>
                        <input type="number" id="max-tokens" value="500" min="50" max="2000">
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>Sistema de Prompt</h3>
                    <div class="control-group">
                        <label for="system-prompt">Prompt do Sistema:</label>
                        <textarea id="system-prompt" rows="5" placeholder="Voc√™ √© um assistente √∫til...">Voc√™ √© um assistente √∫til que responde em portugu√™s brasileiro. Seja conciso e amig√°vel.</textarea>
                    </div>
                    <div class="control-group">
                        <label for="temperature">Criatividade (Temperature):</label>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                        <span id="temperature-value">0.7</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TTS & Voice Configuration Tab -->
        <div id="tts-tab" class="tab-content">
            <h2>üîä Configura√ß√£o de Voz Coqui TTS</h2>
            <div class="config-grid">
                <div class="config-section">
                    <h3>Configura√ß√µes B√°sicas</h3>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="tts-enabled" checked> Ativar TTS
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="tts-language">Idioma:</label>
                        <select id="tts-language">
                            <option value="pt-BR">üáßüá∑ Portugu√™s (BR)</option>
                            <option value="en-US">üá∫üá∏ English (US)</option>
                            <option value="es-ES">üá™üá∏ Espa√±ol (ES)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label style="color: #666; font-style: italic;">Nota: Engine TTS padr√£o agora gerenciado na aba Chat</label>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>üé≠ Coqui TTS - Modelos + Vozes Clonadas</h3>
                    <div class="control-group">
                        <label for="coqui-model">Modelo Portugu√™s BR + Vozes Clonadas:</label>
                        <select id="coqui-model" onchange="onModelChange()">
                            <option value="">üîÑ Carregando modelos e vozes clonadas...</option>
                        </select>
                        <div id="model-status" class="status-message" style="margin-top: 5px; font-size: 11px; min-height: 20px;">
                            üîÑ Verificando modelos TTS e vozes clonadas...
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            üéÜ Inclui modelos Coqui TTS + suas vozes clonadas personalizadas
                        </small>
                    </div>
                    <div class="control-group">
                        <label>üìä Informa√ß√µes do Modelo:</label>
                        <div id="model-info" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #007bff; font-size: 12px; min-height: 40px;">
                            <div id="model-description">Selecione um modelo para ver as informa√ß√µes</div>
                            <div id="model-details" style="margin-top: 5px; color: #666;"></div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="voice-speed">üéõÔ∏è Velocidade da Voz:</label>
                        <input type="range" id="voice-speed" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeedValue(this.value)">
                        <span id="speed-value" style="font-weight: bold; color: #007bff;">1.0x</span>
                    </div>
                    <div class="control-group">
                        <label for="voice-pitch">üéµ Tom da Voz:</label>
                        <input type="range" id="voice-pitch" min="0.5" max="2" step="0.1" value="1" oninput="updatePitchValue(this.value)">
                        <span id="pitch-value" style="font-weight: bold; color: #28a745;">1.0</span>
                    </div>
                    <div class="control-group">
                        <label for="voice-emotion">üòä Intensidade Emocional:</label>
                        <input type="range" id="voice-emotion" min="0" max="1" step="0.1" value="0.5" oninput="updateEmotionValue(this.value)">
                        <span id="emotion-value" style="font-weight: bold; color: #dc3545;">0.5</span>
                    </div>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="voice-cloning-enabled"> üé≠ Ativar Clonagem de Voz
                        </label>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>üìò Dicas para Vozes Clonadas de Qualidade</h3>
                    <div style="background: #e8f4f8; border-left: 4px solid #17a2b8; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #17a2b8;">‚ÑπÔ∏è Importante sobre Vozes Clonadas</h4>
                        <ul style="padding-left: 20px; margin: 10px 0;">
                            <li><strong>√Åudio de refer√™ncia:</strong> Use arquivos WAV/MP3 de 30+ segundos com voz clara</li>
                            <li><strong>Modelo de treinamento:</strong> Nosso sistema usa principalmente voz brasileira</li>
                            <li><strong>Sotaque portugu√™s:</strong> Sotaque europeu pode soar diferente devido ao treinamento</li>
                            <li><strong>Qualidade:</strong> Vozes clonadas s√£o simuladas com tecnologia avan√ßada, mas n√£o perfeitas</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; font-size: 13px;">
                            <strong>üí° Dica:</strong> Para melhor resultado, use refer√™ncias em portugu√™s brasileiro. 
                            Veja o guia completo em <code>CLONED_VOICES_IMPROVEMENT_GUIDE.md</code>
                        </p>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>üé≠ Clonagem de Voz Avan√ßada Enhanced</h3>
                    <div class="voice-cloning-info" style="background: linear-gradient(135deg, #f0f8ff 0%, #e8f4fd 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff; box-shadow: 0 2px 4px rgba(0,123,255,0.1);">
                        <h4>üìù Instru√ß√µes para Clonagem Enhanced:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; font-size: 12px;">
                            <ul style="margin: 0; padding-left: 20px;">
                                <li><strong>Formato:</strong> WAV, MP3 ou FLAC (recomendado: WAV 44.1kHz)</li>
                                <li><strong>Dura√ß√£o:</strong> M√≠nimo 15s, ideal 30-90s</li>
                                <li><strong>Qualidade:</strong> √Åudio limpo, sem ru√≠do de fundo</li>
                            </ul>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li><strong>Conte√∫do:</strong> Fala clara em portugu√™s brasileiro</li>
                                <li><strong>Tamanho:</strong> M√°ximo 50MB para melhor qualidade</li>
                                <li><strong>Ambiente:</strong> Ambiente silencioso, sem eco</li>
                            </ul>
                        </div>
                        <div style="background: #fff; padding: 8px; border-radius: 4px; margin-top: 10px; border: 1px solid #dee2e6;">
                            üìä <strong>Dica Pro:</strong> Para melhor qualidade, grave em ambiente fechado, fale devagar e com boa articula√ß√£o
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="reference-audio">üìÅ √Åudio de Refer√™ncia Enhanced (.wav/.mp3/.flac):</label>
                        <div style="position: relative;">
                            <input type="file" id="reference-audio" accept=".wav,.mp3,.flac" onchange="uploadReferenceAudio(this)" style="margin-bottom: 5px;">
                            <div id="file-validation" style="font-size: 11px; color: #666; margin-top: 5px; min-height: 15px;">
                                Nenhum arquivo selecionado
                            </div>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            üìä Upload de amostra de voz em alta qualidade | Suporte aprimorado para valida√ß√£o autom√°tica
                        </small>
                    </div>
                    <div class="control-group">
                        <label for="cloned-voice-name">üè∑Ô∏è Nome da Voz Clonada Enhanced:</label>
                        <input type="text" id="cloned-voice-name" placeholder="Ex: Voz_Maria_BR_2024" maxlength="50" oninput="validateVoiceName(this.value)">
                        <div id="name-validation" style="font-size: 11px; margin-top: 5px; min-height: 15px;">
                            <span style="color: #666;">Use apenas letras, n√∫meros e sublinhados (m√≠n: 3, m√°x: 50 caracteres)</span>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <button class="btn-small" onclick="trainVoiceClone()" style="background: #28a745; color: white; position: relative;" id="train-btn">
                            üéØ Treinar Modelo Enhanced
                        </button>
                        <button class="btn-small" onclick="testClonedVoice()" style="background: #17a2b8; color: white;" id="test-btn">
                            üé§ Testar Voz
                        </button>
                        <button class="btn-small" onclick="listClonedVoices()" style="background: #6c757d; color: white;">
                            üìÑ Listar Vozes
                        </button>
                        <button class="btn-small" onclick="previewVoiceSample()" style="background: #fd7e14; color: white;" id="preview-btn">
                            üîä Preview Amostra
                        </button>
                    </div>
                    <div id="training-progress" style="display: none; margin: 10px 0;">
                        <div style="background: #f8f9fa; border-radius: 4px; overflow: hidden; border: 1px solid #dee2e6;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997); height: 20px; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="progress-text" style="text-align: center; font-size: 11px; margin-top: 5px; color: #666;">Aguardando in√≠cio do treinamento...</div>
                    </div>
                    <div id="cloning-status" class="status-message" style="min-height: 40px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 11px; line-height: 1.4; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-radius: 6px; padding: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14px;">üîÑ</span>
                            <span>Aguardando upload de √°udio de refer√™ncia... | Sistema Enhanced Pronto</span>
                        </div>
                        <div id="detailed-status" style="margin-top: 5px; color: #666; font-size: 10px;">Sistema de clonagem de voz Enhanced carregado com valida√ß√£o avan√ßada</div>
                    </div>
                </div>
                
                <!-- Add voice testing section to TTS tab -->
                <div class="config-section">
                    <h3>üéß Teste de Voz</h3>
                    <div class="control-group">
                        <label for="test-text">Texto para Teste:</label>
                        <textarea id="test-text" rows="3" placeholder="Digite o texto para testar a s√≠ntese de voz...">Ol√°, este √© um teste da s√≠ntese de voz em portugu√™s brasileiro.</textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn-small" onclick="playTestVoice()">üîä Reproduzir Voz</button>
                        <button class="btn-small" onclick="downloadTestAudio()">üíæ Baixar √Åudio</button>
                    </div>
                    <div id="audio-player" style="margin-top: 10px;"></div>
                    <div id="test-status" class="status-message" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Database Configuration Tab -->
        <div id="database-tab" class="tab-content">
            <h2>üíæ Configura√ß√£o do Banco de Dados</h2>
            <div class="config-grid">
                <div class="config-section">
                    <h3>Conex√£o do Banco</h3>
                    <div class="control-group">
                        <label for="db-type">Tipo de Banco:</label>
                        <select id="db-type" onchange="updateDbConfig()">
                            <option value="sqlite">SQLite (Local)</option>
                            <option value="postgresql">PostgreSQL</option>
                            <option value="mysql">MySQL</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="db-url">URL de Conex√£o:</label>
                        <input type="text" id="db-url" value="sqlite:///./agent_database.db" placeholder="URL do banco de dados">
                    </div>
                    <div class="control-group" id="db-credentials" style="display: none;">
                        <label for="db-host">Host:</label>
                        <input type="text" id="db-host" placeholder="localhost">
                        <label for="db-port">Porta:</label>
                        <input type="number" id="db-port" placeholder="5432">
                        <label for="db-name">Nome do Banco:</label>
                        <input type="text" id="db-name" placeholder="whatsapp_agent">
                        <label for="db-user">Usu√°rio:</label>
                        <input type="text" id="db-user" placeholder="username">
                        <label for="db-password">Senha:</label>
                        <input type="password" id="db-password" placeholder="password">
                    </div>
                    <div class="btn-group">
                        <button class="btn-small" onclick="testDbConnection()">üîç Testar Conex√£o</button>
                        <button class="btn-small" onclick="saveDbConfig()">üíæ Salvar Config</button>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>ü§ñ IA para Banco de Dados</h3>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="ai-queries-enabled" checked> Ativar Consultas com IA
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="ai-query-prompt">Prompt para Consultas IA:</label>
                        <textarea id="ai-query-prompt" rows="3">Voc√™ √© um assistente SQL. Converta perguntas em portugu√™s para consultas SQL seguras.</textarea>
                    </div>
                    <div class="control-group">
                        <label for="natural-query">Consulta em Linguagem Natural:</label>
                        <input type="text" id="natural-query" placeholder="Ex: Quantas mensagens foram enviadas hoje?">
                        <button class="btn-small" onclick="executeNaturalQuery()">üöÄ Executar</button>
                    </div>
                    <div id="query-result" class="query-result"></div>
                </div>
                
                <div class="config-section">
                    <h3>üìä Estat√≠sticas do Banco</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-conversations">0</div>
                            <div class="stat-label">Conversas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-messages">0</div>
                            <div class="stat-label">Mensagens</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-whatsapp">0</div>
                            <div class="stat-label">WhatsApp</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="db-size">0 MB</div>
                            <div class="stat-label">Tamanho DB</div>
                        </div>
                    </div>
                    <button class="btn-small" onclick="refreshStats()">üîÑ Atualizar</button>
                </div>
            </div>
        </div>

        <!-- WhatsApp Configuration Tab -->
        <div id="whatsapp-tab" class="tab-content">
            <h2>üì± Configura√ß√£o WhatsApp Business</h2>
            <div class="config-grid">
                <div class="config-section">
                    <h3>üì± WhatsApp Business API</h3>
                    <div class="control-group">
                        <label for="whatsapp-token">Business Token:</label>
                        <input type="password" id="whatsapp-token" placeholder="Seu WhatsApp Business Token">
                    </div>
                    <div class="control-group">
                        <label for="phone-number-id">Phone Number ID:</label>
                        <input type="text" id="phone-number-id" placeholder="ID do n√∫mero de telefone">
                        <small>Obtido atrav√©s do QR Code de configura√ß√£o do WhatsApp Business</small>
                    </div>
                    <div class="control-group">
                        <label for="verify-token">Verify Token:</label>
                        <input type="text" id="verify-token" value="whatsapp_agent_v2">
                    </div>
                    <div class="control-group">
                        <label for="webhook-url">Webhook URL:</label>
                        <input type="text" id="webhook-url" value="http://localhost:8001/api/whatsapp/webhook" readonly>
                    </div>
                    <div class="btn-group">
                        <button class="btn-small" onclick="generateQRCode()">üì± Gerar QR Code</button>
                        <button class="btn-small" onclick="testWhatsAppConnection()">üîç Testar Conex√£o</button>
                    </div>
                    <div id="qr-code-area" style="margin-top: 15px; text-align: center;"></div>
                </div>
            </div>
        </div>

        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content">
            <h2>üìä Monitoramento do Sistema</h2>
            <div class="monitoring-grid">
                <div class="monitor-section">
                    <h3>Status dos Servi√ßos</h3>
                    <div class="service-list">
                        <div class="service-item">
                            <div class="status-dot" id="monitor-stt"></div>
                            <span>Speech-to-Text (Whisper)</span>
                            <div class="service-details" id="stt-details">-</div>
                        </div>
                        <div class="service-item">
                            <div class="status-dot" id="monitor-llm"></div>
                            <span>LLM Service</span>
                            <div class="service-details" id="llm-details">-</div>
                        </div>
                        <div class="service-item">
                            <div class="status-dot" id="monitor-tts"></div>
                            <span>Text-to-Speech</span>
                            <div class="service-details" id="tts-details">-</div>
                        </div>
                        <div class="service-item">
                            <div class="status-dot" id="monitor-db"></div>
                            <span>Database</span>
                            <div class="service-details" id="db-details">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="monitor-section">
                    <h3>Links √öteis</h3>
                    <div class="links-grid">
                        <button class="link-btn" onclick="window.open('/health', '_blank')">üè• Health Check</button>
                        <button class="link-btn" onclick="window.open('/docs', '_blank')">üìñ API Docs</button>
                        <button class="link-btn" onclick="window.open('/api/status', '_blank')">üìä Status API</button>
                        <button class="link-btn" onclick="window.open('/api/models', '_blank')">üß† Modelos</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Enhanced WhatsApp Voice Agent V2 | Vers√£o 2.1.0 | 
            <span id="status-text">Inicializando...</span>
        </div>
    </div>

    <script>
        let websocket = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let sessionId = null;
        let messageCount = 0;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            setupTabEventListeners();
        });

        // Tab Management
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const activeButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load tab-specific data
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'database':
                    refreshStats();
                    break;
                case 'monitoring':
                    updateMonitoringStatus();
                    break;
                case 'tts':
                    checkCoquiModels();
                    break;
                case 'history':
                    loadConversationHistory();
                    break;
            }
        }

        function setupTabEventListeners() {
            // Temperature slider
            const tempSlider = document.getElementById('temperature');
            const tempValue = document.getElementById('temperature-value');
            if (tempSlider && tempValue) {
                tempSlider.addEventListener('input', (e) => {
                    tempValue.textContent = e.target.value;
                });
            }

            // Voice speed slider
            const speedSlider = document.getElementById('voice-speed');
            const speedValue = document.getElementById('speed-value');
            if (speedSlider && speedValue) {
                speedSlider.addEventListener('input', (e) => {
                    speedValue.textContent = e.target.value + 'x';
                });
            }

            // Database type change
            const dbType = document.getElementById('db-type');
            if (dbType) {
                dbType.addEventListener('change', updateDbConfig);
            }
        }

        async function initializeApp() {
            updateStatus('Conectando aos servi√ßos...');
            
            // Check system health
            await checkSystemHealth();
            
            // Load available models
            await loadAvailableModels();
            
            // Initialize WebSocket
            initializeWebSocket();
            
            // Set up event listeners
            setupEventListeners();
            
            updateStatus('Sistema pronto!');
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                // Update service status indicators
                updateServiceStatus('stt-status', health.services.whisper_stt.status);
                updateServiceStatus('llm-status', health.services.llm_service.status);
                updateServiceStatus('tts-status', health.services.tts_service.status);
                updateServiceStatus('db-status', health.services.database.status);
                
                console.log('System health:', health);
            } catch (error) {
                console.error('Health check failed:', error);
                updateStatus('Erro ao verificar sa√∫de do sistema');
            }
        }

        function updateServiceStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status-dot';
            if (status === 'healthy' || status === 'ready') {
                element.classList.add('healthy');
            } else if (status === 'starting' || status === 'loading') {
                element.classList.add('loading');
            }
        }

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/models');
                const models = await response.json();
                
                const providerSelect = document.getElementById('llm-provider');
                const modelSelect = document.getElementById('llm-model');
                
                providerSelect.addEventListener('change', () => {
                    updateModelOptions(models);
                });
                
                // Set default provider
                providerSelect.value = models.default_provider || 'openrouter';
                updateModelOptions(models);
                
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        function updateModelOptions(models) {
            const provider = document.getElementById('llm-provider').value;
            const modelSelect = document.getElementById('llm-model');
            
            modelSelect.innerHTML = '';
            
            if (models.providers[provider]) {
                models.providers[provider].models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    if (model === models.providers[provider].default_model) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            }
        }

        function initializeWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = (event) => {
                console.log('WebSocket connected');
                updateServiceStatus('ws-status', 'healthy');
                updateStatus('WebSocket conectado');
            };
            
            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            websocket.onclose = (event) => {
                console.log('WebSocket disconnected');
                updateServiceStatus('ws-status', 'error');
                updateStatus('WebSocket desconectado');
                
                // Attempt to reconnect
                setTimeout(() => {
                    updateStatus('Tentando reconectar...');
                    initializeWebSocket();
                }, 3000);
            };
            
            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateServiceStatus('ws-status', 'error');
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'connection') {
                sessionId = data.session_id;
                document.getElementById('session-id').textContent = sessionId.substring(0, 8);
                addMessage('assistant', data.message, 'WebSocket');
            } else if (data.type === 'response') {
                // Check if TTS audio data is available
                const audioData = data.audio_data || null;
                addMessage('assistant', data.message, data.provider, audioData);
                document.getElementById('last-provider').textContent = data.provider;
                messageCount++;
                document.getElementById('message-count').textContent = messageCount;
                
                // Log TTS info if available
                if (data.tts_info) {
                    console.log('TTS info:', data.tts_info);
                }
            }
        }

        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Send via WebSocket
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const data = {
                    type: 'chat',
                    message: message,
                    provider: document.getElementById('llm-provider').value,
                    model: document.getElementById('llm-model').value,
                    system_prompt: document.getElementById('system-prompt').value,
                    use_tts: document.getElementById('tts-enabled').checked,
                    tts_engine: document.getElementById('default-tts-engine').value
                };
                
                websocket.send(JSON.stringify(data));
            } else {
                // Fallback to HTTP API
                await sendMessageHTTP(message);
            }
        }

        async function sendMessageHTTP(message) {
            try {
                const startTime = Date.now();
                updateStatus('Processando mensagem...');
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        llm_provider: document.getElementById('llm-provider').value,
                        llm_model: document.getElementById('llm-model').value,
                        use_tts: document.getElementById('tts-enabled').checked,
                        tts_engine: document.getElementById('default-tts-engine').value,
                        tts_voice: document.getElementById('coqui-model').value  // Add selected voice
                    })
                });
                
                const result = await response.json();
                const responseTime = Date.now() - startTime;
                
                if (result.success) {
                    // Check if TTS audio data is available
                    const audioData = result.audio_data || null;
                    addMessage('assistant', result.bot_response, result.llm_provider || 'API', audioData);
                    document.getElementById('response-time').textContent = `${responseTime}ms`;
                    document.getElementById('last-provider').textContent = result.llm_provider || 'API';
                    messageCount++;
                    document.getElementById('message-count').textContent = messageCount;
                    
                    if (result.has_audio && result.tts_info) {
                        // Handle TTS audio if available
                        console.log('TTS audio available:', result.tts_info);
                    }
                } else {
                    addMessage('assistant', 'Erro ao processar mensagem.', 'Error');
                }
                
                updateStatus('Sistema pronto!');
                
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('assistant', 'Erro de conex√£o. Tente novamente.', 'Error');
                updateStatus('Erro de conex√£o');
            }
        }

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioToSTT(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const recordBtn = document.getElementById('record-btn');
                const stopBtn = document.getElementById('stop-btn');
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                recordBtn.disabled = true;
                
                updateStatus('üé§ Gravando √°udio... Clique em PARAR para finalizar');
                
            } catch (error) {
                console.error('Error starting recording:', error);
                updateStatus('‚ùå Erro ao acessar microfone');
                // Reset buttons on error
                const recordBtn = document.getElementById('record-btn');
                const stopBtn = document.getElementById('stop-btn');
                recordBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                recordBtn.disabled = false;
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                const recordBtn = document.getElementById('record-btn');
                const stopBtn = document.getElementById('stop-btn');
                recordBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                recordBtn.disabled = false;
                
                updateStatus('‚è≥ Processando √°udio...');
            }
        }

        async function sendAudioToSTT(audioBlob) {
            try {
                // Show transcription progress immediately
                updateStatus('üé§ Enviando √°udio para transcri√ß√£o...');
                
                // Add a temporary message showing transcription is in progress
                const tempMessageId = 'temp-transcription-' + Date.now();
                addTemporaryMessage(tempMessageId, 'üîÑ Transcrevendo √°udio...', 'transcribing');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.webm');
                
                const response = await fetch('/api/stt', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Remove temporary message
                removeTemporaryMessage(tempMessageId);
                
                if (result.success && result.text) {
                    // Show transcribed text clearly in chat
                    addMessage('user', `üé§ Transcri√ß√£o: "${result.text}"`, 'STT');
                    
                    const messageInput = document.getElementById('message-input');
                    messageInput.value = result.text;
                    updateStatus('‚úÖ √Åudio transcrito com sucesso!');
                    
                    // Visual confirmation with border highlight
                    messageInput.style.border = '2px solid #4CAF50';
                    messageInput.style.backgroundColor = '#f0f8f0';
                    
                    setTimeout(() => {
                        messageInput.style.border = '';
                        messageInput.style.backgroundColor = '';
                    }, 2000);
                    
                    // Auto-send the transcribed message after a short delay
                    setTimeout(() => {
                        sendMessage();
                    }, 1000);
                } else {
                    addMessage('system', `‚ùå Erro na transcri√ß√£o: ${result.error || 'Falha no processamento do √°udio'}`, 'STT Error');
                    updateStatus('‚ùå Erro na transcri√ß√£o do √°udio');
                }
                
            } catch (error) {
                console.error('Error sending audio to STT:', error);
                removeTemporaryMessage('temp-transcription-' + Date.now());
                addMessage('system', `‚ùå Erro de conex√£o STT: ${error.message}`, 'STT Error');
                updateStatus('‚ùå Erro ao enviar √°udio para transcri√ß√£o');
            }
        }
        
        function addTemporaryMessage(id, content, type) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = `message ${type} temporary-message`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="transcription-progress">
                    <div class="spinner"></div>
                    ${content}
                </div>
                <div class="message-meta">${timestamp}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function removeTemporaryMessage(id) {
            const tempMessage = document.getElementById(id);
            if (tempMessage) {
                tempMessage.remove();
            }
        }

        function addMessage(type, content, provider = '', audioData = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const meta = provider ? `${provider} ‚Ä¢ ${timestamp}` : timestamp;
            
            // Create unique ID for this message
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            messageDiv.id = messageId;
            
            let audioPlayerHtml = '';
            if (audioData && type === 'assistant') {
                // Create audio player controls for TTS
                audioPlayerHtml = `
                    <div class="tts-audio-player" data-message-id="${messageId}">
                        <button class="audio-play-btn" onclick="playTTSAudio('${messageId}')" title="Reproduzir TTS">
                            üîä
                        </button>
                        <button class="audio-stop-btn" onclick="stopTTSAudio('${messageId}')" title="Parar TTS" style="display: none;">
                            ‚èπÔ∏è
                        </button>
                        <span class="tts-status">TTS dispon√≠vel</span>
                    </div>
                `;
                
                // Store audio data on the message element
                messageDiv.setAttribute('data-audio', audioData);
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                ${audioPlayerHtml}
                <div class="message-meta">${meta}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function testServices() {
            updateStatus('Testando servi√ßos...');
            
            try {
                // Test health endpoint
                const healthResponse = await fetch('/health');
                const health = await healthResponse.json();
                
                // Test LLM
                const llmResponse = await fetch('/api/llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Hello test',
                        provider: 'local'
                    })
                });
                const llmResult = await llmResponse.json();
                
                addMessage('assistant', `‚úÖ Teste de servi√ßos conclu√≠do:
‚Ä¢ STT: ${health.services.whisper_stt.status}
‚Ä¢ LLM: ${llmResult.success ? 'OK' : 'Error'}
‚Ä¢ TTS: ${health.services.tts_service.status}
‚Ä¢ Database: ${health.services.database.status}`, 'Test');
                
                updateStatus('Testes conclu√≠dos!');
                
            } catch (error) {
                console.error('Service test failed:', error);
                addMessage('assistant', '‚ùå Erro nos testes de servi√ßos.', 'Test');
                updateStatus('Erro nos testes');
            }
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            messageCount = 0;
            document.getElementById('message-count').textContent = '0';
            updateStatus('Chat limpo');
        }

        function updateStatus(message) {
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = message;
            }
        }

        // TTS Audio Player Functions
        let currentAudio = null;
        let currentMessageId = null;
        
        function playTTSAudio(messageId) {
            try {
                // Stop any currently playing audio
                if (currentAudio) {
                    stopTTSAudio(currentMessageId);
                }
                
                // Find the message element
                const messageElement = document.getElementById(messageId);
                if (!messageElement) {
                    console.error('Message element not found:', messageId);
                    return;
                }
                
                // Get audio data from the message element
                const audioData = messageElement.getAttribute('data-audio');
                if (!audioData) {
                    console.error('No audio data found for message:', messageId);
                    return;
                }
                
                // Create and play audio
                currentAudio = new Audio('data:audio/wav;base64,' + audioData);
                currentMessageId = messageId;
                
                // Update UI elements
                const playBtn = messageElement.querySelector('.audio-play-btn');
                const stopBtn = messageElement.querySelector('.audio-stop-btn');
                const status = messageElement.querySelector('.tts-status');
                
                if (playBtn) playBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'flex';
                if (status) {
                    status.textContent = 'Reproduzindo...';
                    status.classList.add('playing');
                }
                
                // Set up audio event listeners
                currentAudio.onended = () => {
                    stopTTSAudio(messageId);
                };
                
                currentAudio.onerror = (error) => {
                    console.error('Audio playback error:', error);
                    stopTTSAudio(messageId);
                    if (status) status.textContent = 'Erro na reprodu√ß√£o';
                };
                
                // Play the audio
                currentAudio.play();
                
            } catch (error) {
                console.error('Error playing TTS audio:', error);
            }
        }
        
        function stopTTSAudio(messageId) {
            try {
                // Stop current audio if playing
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }
                
                // Reset UI for the specific message
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    const playBtn = messageElement.querySelector('.audio-play-btn');
                    const stopBtn = messageElement.querySelector('.audio-stop-btn');
                    const status = messageElement.querySelector('.tts-status');
                    
                    if (playBtn) playBtn.style.display = 'flex';
                    if (stopBtn) stopBtn.style.display = 'none';
                    if (status) {
                        status.textContent = 'TTS dispon√≠vel';
                        status.classList.remove('playing');
                    }
                }
                
                currentMessageId = null;
                
            } catch (error) {
                console.error('Error stopping TTS audio:', error);
            }
        }

        // TTS and Voice Cloning Functions
        async function uploadReferenceAudio(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('cloning-status');
            statusDiv.innerHTML = 'üìé Validando arquivo de √°udio...';
            
            // Validate file size
            if (file.size > 25 * 1024 * 1024) {
                statusDiv.innerHTML = '‚ùå Arquivo muito grande! M√°ximo 25MB';
                input.value = '';
                return;
            }
            
            // Validate file type
            const validTypes = ['audio/wav', 'audio/mp3', 'audio/mpeg', 'audio/flac'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(wav|mp3|flac)$/i)) {
                statusDiv.innerHTML = '‚ùå Formato inv√°lido! Use WAV, MP3 ou FLAC';
                input.value = '';
                return;
            }
            
            statusDiv.innerHTML = 'üì§ Fazendo upload do √°udio de refer√™ncia...';
            
            const formData = new FormData();
            formData.append('audio', file);
            
            try {
                const response = await fetch('/api/tts/upload-reference', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    statusDiv.innerHTML = `‚úÖ Upload realizado com sucesso! Arquivo: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`;
                } else {
                    statusDiv.innerHTML = '‚ùå Upload falhou: ' + result.error;
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro no upload: ' + error.message;
            }
        }

        async function trainVoiceClone() {
            const voiceName = document.getElementById('cloned-voice-name').value.trim();
            const statusDiv = document.getElementById('cloning-status');
            
            if (!validateVoiceName(voiceName)) {
                statusDiv.innerHTML = '‚ö†Ô∏è Por favor, insira um nome v√°lido para a voz';
                return;
            }
            
            const fileInput = document.getElementById('reference-audio');
            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '‚ö†Ô∏è Por favor, fa√ßa upload de um √°udio de refer√™ncia primeiro';
                return;
            }
            
            statusDiv.innerHTML = 'üéØ Iniciando treinamento Enhanced do modelo de voz...';
            showTrainingProgress();
            
            try {
                const response = await fetch('/api/tts/train-clone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voice_name: voiceName })
                });
                
                const result = await response.json();
                if (result.success) {
                    statusDiv.innerHTML = `‚úÖ Modelo '${voiceName}' treinado com sucesso! | ‚è±Ô∏è Tempo: ${result.training_time || 'N/A'} | üé§ Pronto para uso`;
                    
                    // Enable test button
                    document.getElementById('test-btn').disabled = false;
                } else {
                    statusDiv.innerHTML = '‚ùå Treinamento falhou: ' + result.error;
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro no treinamento: ' + error.message;
            }
        }

        async function testClonedVoice() {
            const voiceName = document.getElementById('cloned-voice-name').value.trim();
            const statusDiv = document.getElementById('cloning-status');
            
            if (!voiceName) {
                statusDiv.innerHTML = '‚ö†Ô∏è Por favor, insira o nome da voz para testar';
                return;
            }
            
            statusDiv.innerHTML = 'üéôÔ∏è Testando voz clonada...';
            
            try {
                const response = await fetch('/api/tts/test-clone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voice_name: voiceName,
                        text: 'Ol√°, esta √© a sua voz clonada falando em portugu√™s brasileiro. Como voc√™ pode ouvir, a qualidade da s√≠ntese √© muito boa.'
                    })
                });
                
                const result = await response.json();
                if (result.success && result.audio_data) {
                    // Play the generated audio
                    const audio = new Audio('data:audio/wav;base64,' + result.audio_data);
                    audio.play();
                    statusDiv.innerHTML = `‚úÖ Teste conclu√≠do! Voz '${voiceName}' reproduzida com sucesso.`;
                } else {
                    statusDiv.innerHTML = '‚ùå Teste falhou: ' + (result.error || 'Nenhum √°udio gerado');
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro no teste: ' + error.message;
            }
        }
        
        async function listClonedVoices() {
            const statusDiv = document.getElementById('cloning-status');
            statusDiv.innerHTML = 'üîç Listando vozes clonadas...';
            
            try {
                const response = await fetch('/api/tts/list-cloned-voices');
                const result = await response.json();
                
                if (result.success && result.voices) {
                    if (result.voices.length === 0) {
                        statusDiv.innerHTML = 'üìÑ Nenhuma voz clonada encontrada. Fa√ßa upload de um √°udio de refer√™ncia primeiro.';
                    } else {
                        let voicesList = result.voices.map(voice => 
                            `‚Ä¢ ${voice.name} (${voice.date_created || 'N/A'})`
                        ).join('<br>');
                        statusDiv.innerHTML = `üìÑ Vozes dispon√≠veis (${result.voices.length}):<br>${voicesList}`;
                    }
                } else {
                    statusDiv.innerHTML = '‚ùå Erro ao listar vozes: ' + (result.error || 'Falha desconhecida');
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro na consulta: ' + error.message;
            }
        }

        async function checkCoquiModels() {
            try {
                const response = await fetch('/api/tts/models');
                const result = await response.json();
                
                if (result.success) {
                    console.log('Available Coqui models:', result.models);
                    // Update model selector with available models
                    const modelSelect = document.getElementById('coqui-model');
                    if (modelSelect && result.models) {
                        modelSelect.innerHTML = '';
                        result.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.name;
                            option.textContent = model.display_name || model.name;
                            modelSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error checking Coqui models:', error);
            }
        }

        // Database Functions
        function updateDbConfig() {
            const dbType = document.getElementById('db-type').value;
            const credentialsDiv = document.getElementById('db-credentials');
            const dbUrl = document.getElementById('db-url');
            
            if (dbType === 'sqlite') {
                credentialsDiv.style.display = 'none';
                dbUrl.value = 'sqlite:///./agent_database.db';
            } else {
                credentialsDiv.style.display = 'block';
                if (dbType === 'postgresql') {
                    dbUrl.value = 'postgresql://user:password@localhost:5432/whatsapp_agent';
                } else if (dbType === 'mysql') {
                    dbUrl.value = 'mysql://user:password@localhost:3306/whatsapp_agent';
                }
            }
        }

        async function testDbConnection() {
            const dbUrl = document.getElementById('db-url').value;
            
            try {
                const response = await fetch('/api/database/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ database_url: dbUrl })
                });
                
                const result = await response.json();
                alert(result.success ? '‚úÖ Connection successful!' : '‚ùå Connection failed: ' + result.error);
            } catch (error) {
                alert('‚ùå Connection error: ' + error.message);
            }
        }

        async function saveDbConfig() {
            const config = {
                db_type: document.getElementById('db-type').value,
                db_url: document.getElementById('db-url').value,
                ai_queries_enabled: document.getElementById('ai-queries-enabled').checked
            };
            
            try {
                const response = await fetch('/api/database/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                alert(result.success ? '‚úÖ Configuration saved!' : '‚ùå Save failed: ' + result.error);
            } catch (error) {
                alert('‚ùå Save error: ' + error.message);
            }
        }

        async function executeNaturalQuery() {
            const query = document.getElementById('natural-query').value;
            const resultDiv = document.getElementById('query-result');
            
            if (!query.trim()) {
                resultDiv.innerHTML = '‚ö†Ô∏è Please enter a query';
                return;
            }
            
            resultDiv.innerHTML = 'üîç Processing query...';
            
            try {
                const response = await fetch('/api/database/natural-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        ai_prompt: document.getElementById('ai-query-prompt').value
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    resultDiv.innerHTML = `
                        <strong>SQL Generated:</strong><br>
                        <code>${result.sql}</code><br><br>
                        <strong>Results:</strong><br>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = '‚ùå Query failed: ' + result.error;
                }
            } catch (error) {
                resultDiv.innerHTML = '‚ùå Query error: ' + error.message;
            }
        }

        async function refreshStats() {
            try {
                const response = await fetch('/api/database/stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('total-conversations').textContent = result.stats.conversations || 0;
                    document.getElementById('total-messages').textContent = result.stats.messages || 0;
                    document.getElementById('total-whatsapp').textContent = result.stats.whatsapp || 0;
                    document.getElementById('db-size').textContent = (result.stats.db_size || 0) + ' MB';
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        async function updateMonitoringStatus() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                // Update monitoring status dots and details
                updateServiceStatus('monitor-stt', health.services?.whisper_stt?.status || 'unknown');
                updateServiceStatus('monitor-llm', health.services?.llm_service?.status || 'unknown');
                updateServiceStatus('monitor-tts', health.services?.tts_service?.status || 'unknown');
                updateServiceStatus('monitor-db', health.services?.database?.status || 'unknown');
                
                document.getElementById('stt-details').textContent = health.services?.whisper_stt?.details || '-';
                document.getElementById('llm-details').textContent = health.services?.llm_service?.details || '-';
                document.getElementById('tts-details').textContent = health.services?.tts_service?.details || '-';
                document.getElementById('db-details').textContent = health.services?.database?.details || '-';
                
            } catch (error) {
                console.error('Error updating monitoring status:', error);
            }
        }

        // Add JavaScript functions for new features
        async function playTestVoice() {
            const text = document.getElementById('test-text').value;
            const statusDiv = document.getElementById('test-status');
            
            if (!text.trim()) {
                statusDiv.innerHTML = '‚ö†Ô∏è Digite um texto para testar';
                statusDiv.style.display = 'block';
                return;
            }
            
            statusDiv.innerHTML = 'üîÑ Gerando √°udio...';
            statusDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        language: document.getElementById('tts-language').value,
                        voice: document.getElementById('coqui-model').value,
                        engine: window.defaultTTSEngine || 'gtts', // Use default TTS engine
                        speed: parseFloat(document.getElementById('voice-speed').value)
                    })
                });
                
                const result = await response.json();
                if (result.success && result.audio_data) {
                    const audio = new Audio('data:audio/wav;base64,' + result.audio_data);
                    audio.play();
                    
                    // Add audio player to page
                    document.getElementById('audio-player').innerHTML = `
                        <audio controls style="width: 100%;">
                            <source src="data:audio/wav;base64,${result.audio_data}" type="audio/wav">
                        </audio>
                    `;
                    
                    statusDiv.innerHTML = '‚úÖ √Åudio reproduzido com sucesso!';
                } else {
                    statusDiv.innerHTML = '‚ùå Erro ao gerar √°udio: ' + (result.error || 'Falha desconhecida');
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro de conex√£o: ' + error.message;
            }
        }

        async function downloadTestAudio() {
            const text = document.getElementById('test-text').value;
            const statusDiv = document.getElementById('test-status');
            
            if (!text.trim()) {
                statusDiv.innerHTML = '‚ö†Ô∏è Digite um texto para gerar √°udio';
                statusDiv.style.display = 'block';
                return;
            }
            
            statusDiv.innerHTML = 'üíæ Preparando download...';
            statusDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        language: document.getElementById('tts-language').value,
                        voice: document.getElementById('coqui-model').value,
                        engine: window.defaultTTSEngine || 'gtts', // Use default TTS engine
                        speed: parseFloat(document.getElementById('voice-speed').value)
                    })
                });
                
                const result = await response.json();
                if (result.success && result.audio_data) {
                    // Create download link
                    const blob = new Blob([Uint8Array.from(atob(result.audio_data), c => c.charCodeAt(0))], {type: 'audio/wav'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'coqui_tts_test.wav';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    statusDiv.innerHTML = '‚úÖ Download iniciado!';
                } else {
                    statusDiv.innerHTML = '‚ùå Erro ao gerar √°udio para download';
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro no download: ' + error.message;
            }
        }

        function generateQRCode() {
            const phoneId = document.getElementById('phone-number-id').value;
            const qrArea = document.getElementById('qr-code-area');
            
            if (!phoneId) {
                qrArea.innerHTML = '‚ö†Ô∏è Configure o Phone Number ID primeiro';
                return;
            }
            
            // Generate QR code for WhatsApp Business setup
            qrArea.innerHTML = `
                <div style="border: 2px solid #25D366; padding: 20px; border-radius: 10px; background: white;">
                    <h4>üì± QR Code para WhatsApp Business</h4>
                    <div style="margin: 15px 0;">
                        [QR CODE PLACEHOLDER - Phone ID: ${phoneId}]
                    </div>
                    <p style="font-size: 12px;">Escaneie com WhatsApp Business para configurar webhook</p>
                </div>
            `;
        }

        async function testWhatsAppConnection() {
            const token = document.getElementById('whatsapp-token').value;
            const phoneId = document.getElementById('phone-number-id').value;
            
            if (!token || !phoneId) {
                alert('‚ö†Ô∏è Configure o Business Token e Phone ID primeiro');
                return;
            }
            
            try {
                const response = await fetch('/api/whatsapp/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        phone_id: phoneId
                    })
                });
                
                const result = await response.json();
                alert(result.success ? '‚úÖ Conex√£o WhatsApp OK!' : '‚ùå Falha na conex√£o: ' + result.error);
            } catch (error) {
                alert('‚ùå Erro de teste: ' + error.message);
            }
        }

        // Enhanced TTS Functions
        async function loadTTSModels() {
            const modelSelect = document.getElementById('coqui-model');
            const statusDiv = document.getElementById('model-status');
            
            try {
                statusDiv.innerHTML = 'üîÑ Carregando modelos TTS e vozes clonadas...';
                
                // Carregar modelos Coqui TTS
                const modelsResponse = await fetch('/api/tts/models');
                const modelsResult = await modelsResponse.json();
                
                if (modelsResult.success) {
                    modelSelect.innerHTML = '';
                    
                    // Adicionar modelos Coqui padr√£o
                    const defaultGroup = document.createElement('optgroup');
                    defaultGroup.label = 'üé≠ Modelos Coqui TTS Padr√£o';
                    
                    modelsResult.models.forEach(model => {
                        // Only show Coqui models (not cloned voices which are handled separately)
                        if (!model.is_cloned) {
                            const option = document.createElement('option');
                            option.value = model.name;
                            option.textContent = model.display_name;
                            option.dataset.quality = model.quality;
                            option.dataset.gender = model.gender;
                            option.dataset.description = model.description;
                            defaultGroup.appendChild(option);
                        }
                    });
                    modelSelect.appendChild(defaultGroup);
                    
                    // Adicionar vozes clonadas separadamente
                    const clonedVoices = modelsResult.models.filter(model => model.is_cloned);
                    if (clonedVoices.length > 0) {
                        const clonedGroup = document.createElement('optgroup');
                        clonedGroup.label = 'üé§ Suas Vozes Clonadas';
                        
                        clonedVoices.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.name;  // This will be 'cloned_voice_name'
                            option.textContent = model.display_name;
                            option.dataset.quality = model.quality;
                            option.dataset.gender = model.gender;
                            option.dataset.description = model.description;
                            option.dataset.type = 'cloned';
                            clonedGroup.appendChild(option);
                        });
                        modelSelect.appendChild(clonedGroup);
                    }
                    
                    const totalModels = modelsResult.models.length;
                    statusDiv.innerHTML = `‚úÖ ${modelsResult.models.filter(m => !m.is_cloned).length} modelos + ${clonedVoices.length} vozes clonadas carregadas`;
                } else {
                    statusDiv.innerHTML = '‚ùå Erro ao carregar modelos: ' + (modelsResult.error || 'Resposta inv√°lida');
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Falha na conex√£o: ' + error.message;
            }
        }
        
        function onModelChange() {
            const modelSelect = document.getElementById('coqui-model');
            const selectedOption = modelSelect.selectedOptions[0];
            const descDiv = document.getElementById('model-description');
            const detailsDiv = document.getElementById('model-details');
            
            if (selectedOption && selectedOption.dataset.description) {
                descDiv.textContent = selectedOption.dataset.description;
                detailsDiv.innerHTML = `
                    üìä <strong>Qualidade:</strong> ${selectedOption.dataset.quality} | 
                    üë§ <strong>G√™nero:</strong> ${selectedOption.dataset.gender} |
                    üéØ <strong>Tipo:</strong> Neural TTS
                `;
            } else {
                descDiv.textContent = 'Selecione um modelo para ver as informa√ß√µes';
                detailsDiv.textContent = '';
            }
        }
        
        function updateSpeedValue(value) {
            document.getElementById('speed-value').textContent = value + 'x';
        }
        
        function updatePitchValue(value) {
            document.getElementById('pitch-value').textContent = value;
        }
        
        function updateDefaultTTS() {
            const ttsEngine = document.getElementById('default-tts-engine').value;
            
            // Salvar prefer√™ncia no localStorage
            localStorage.setItem('defaultTTSEngine', ttsEngine);
            
            // Atualizar vari√°vel global
            window.defaultTTSEngine = ttsEngine;
            
            // Feedback visual
            const statusText = document.getElementById('status-text');
            const engineNames = {
                'gtts': 'Google TTS (Flash)',
                'coqui': 'Coqui TTS',
                'pyttsx3': 'pyttsx3 (Offline)'
            };
            
            if (statusText) {
                statusText.textContent = `TTS padr√£o: ${engineNames[ttsEngine]}`;
                setTimeout(() => {
                    statusText.textContent = 'Sistema pronto!';
                }, 3000);
            }
            
            console.log(`üéõÔ∏è TTS padr√£o atualizado para: ${engineNames[ttsEngine]}`);
        }
        
        function loadDefaultTTSPreference() {
            const savedEngine = localStorage.getItem('defaultTTSEngine') || 'gtts'; // Google TTS como padr√£o
            const engineSelect = document.getElementById('default-tts-engine');
            
            if (engineSelect) {
                engineSelect.value = savedEngine;
                window.defaultTTSEngine = savedEngine;
            }
        }
        
        function validateVoiceName(name) {
            const validationDiv = document.getElementById('name-validation');
            
            if (!name) {
                validationDiv.innerHTML = '<span style="color: #666;">Use apenas letras, n√∫meros e sublinhados (m√≠n: 3, m√°x: 50 caracteres)</span>';
                return false;
            }
            
            if (name.length < 3) {
                validationDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Nome muito curto (m√≠nimo 3 caracteres)</span>';
                return false;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                validationDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Use apenas letras, n√∫meros e sublinhados</span>';
                return false;
            }
            
            validationDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Nome v√°lido</span>';
            return true;
        }
        
        async function previewVoiceSample() {
            const fileInput = document.getElementById('reference-audio');
            const statusDiv = document.getElementById('cloning-status');
            
            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '‚ö†Ô∏è Selecione um arquivo de √°udio primeiro';
                return;
            }
            
            const file = fileInput.files[0];
            statusDiv.innerHTML = 'üîä Reproduzindo amostra de refer√™ncia...';
            
            try {
                const url = URL.createObjectURL(file);
                const audio = new Audio(url);
                
                audio.onloadedmetadata = () => {
                    const duration = audio.duration;
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    statusDiv.innerHTML = `üéµ Reproduzindo: ${file.name} | ‚è±Ô∏è ${duration.toFixed(1)}s | üìä ${fileSize}MB`;
                };
                
                audio.onended = () => {
                    statusDiv.innerHTML = '‚úÖ Preview conclu√≠do. Arquivo pronto para treinamento.';
                    URL.revokeObjectURL(url);
                };
                
                audio.onerror = () => {
                    statusDiv.innerHTML = '‚ùå Erro ao reproduzir arquivo de √°udio';
                    URL.revokeObjectURL(url);
                };
                
                audio.play();
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro no preview: ' + error.message;
            }
        }
        
        // Enhanced Training Progress
        function showTrainingProgress() {
            const progressDiv = document.getElementById('training-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressDiv.style.display = 'block';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                
                if (progress < 20) {
                    progressText.textContent = 'üîÑ Processando √°udio de refer√™ncia...';
                } else if (progress < 50) {
                    progressText.textContent = 'üß† Extraindo caracter√≠sticas de voz...';
                } else if (progress < 80) {
                    progressText.textContent = 'üéØ Treinando modelo neural...';
                } else if (progress < 100) {
                    progressText.textContent = '‚úÖ Finalizando e salvando modelo...';
                } else {
                    progressText.textContent = 'üéâ Treinamento conclu√≠do com sucesso!';
                    clearInterval(interval);
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 2000);
                }
            }, 200);
        }

        // History Tab Functions
        async function loadConversationHistory() {
            try {
                const response = await fetch('/api/history/conversations');
                const result = await response.json();
                
                if (result.success) {
                    updateHistoryStats(result.stats);
                    displayConversationsList(result.conversations);
                } else {
                    console.error('Error loading conversation history:', result.error);
                }
            } catch (error) {
                console.error('Error loading conversation history:', error);
            }
        }

        function updateHistoryStats(stats) {
            document.getElementById('history-stats').textContent = `${stats.total || 0} conversas encontradas`;
            document.getElementById('total-conversations-stat').textContent = stats.total || 0;
            document.getElementById('total-messages-stat').textContent = stats.total_messages || 0;
            document.getElementById('avg-response-time').textContent = (stats.avg_response_time || 0) + 's';
            document.getElementById('today-messages').textContent = stats.today_messages || 0;
        }

        function displayConversationsList(conversations) {
            const listContainer = document.getElementById('conversations-list');
            
            if (!conversations || conversations.length === 0) {
                listContainer.innerHTML = `
                    <div class="conversation-item empty" style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                        <div>Nenhuma conversa encontrada</div>
                        <div style="font-size: 12px; margin-top: 5px;">Inicie uma conversa para ver o hist√≥rico aqui</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            conversations.forEach(conv => {
                html += `
                    <div class="conversation-item" onclick="showConversationDetail('${conv.id}')" style="
                        padding: 10px; margin: 5px 0; background: white; border: 1px solid #ddd; 
                        border-radius: 5px; cursor: pointer; transition: all 0.3s ease;
                    " onmouseover="this.style.backgroundColor='#f0f8ff'" onmouseout="this.style.backgroundColor='white'">
                        <div style="font-weight: bold; font-size: 14px; color: #333;">
                            ${conv.source === 'whatsapp' ? 'üì±' : 'üíª'} ${conv.title || 'Conversa sem t√≠tulo'}
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            üìÖ ${new Date(conv.created_at).toLocaleString('pt-BR')}
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 2px;">
                            üí¨ ${conv.message_count} mensagens | ‚è±Ô∏è ${conv.source}
                        </div>
                    </div>
                `;
            });
            listContainer.innerHTML = html;
        }

        async function showConversationDetail(conversationId) {
            try {
                const response = await fetch(`/api/history/conversation/${conversationId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayConversationDetail(result.conversation);
                } else {
                    document.getElementById('conversation-detail').innerHTML = '‚ùå Erro ao carregar detalhes da conversa';
                }
            } catch (error) {
                document.getElementById('conversation-detail').innerHTML = '‚ùå Erro de conex√£o: ' + error.message;
            }
        }

        function displayConversationDetail(conversation) {
            const titleEl = document.getElementById('conversation-title');
            const contentEl = document.getElementById('conversation-detail');
            
            titleEl.textContent = `üìù ${conversation.title || 'Conversa'} - ${new Date(conversation.created_at).toLocaleString('pt-BR')}`;
            
            let html = `
                <div class="conversation-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4>‚ÑπÔ∏è Informa√ß√µes da Conversa</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div><strong>ID:</strong> ${conversation.id}</div>
                        <div><strong>Origem:</strong> ${conversation.source === 'whatsapp' ? 'üì± WhatsApp' : 'üíª Web Interface'}</div>
                        <div><strong>Criada em:</strong> ${new Date(conversation.created_at).toLocaleString('pt-BR')}</div>
                        <div><strong>Mensagens:</strong> ${conversation.messages.length}</div>
                    </div>
                </div>
                
                <div class="messages-container">
                    <h4>üí¨ Mensagens</h4>
            `;
            
            conversation.messages.forEach(msg => {
                const isUser = msg.role === 'user';
                html += `
                    <div class="message ${isUser ? 'user' : 'assistant'}" style="
                        margin: 10px 0; padding: 12px; border-radius: 10px; max-width: 85%;
                        ${isUser ? 'margin-left: auto; background: #007bff; color: white;' : 'background: white; border: 1px solid #ddd;'}
                    ">
                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">
                            ${isUser ? 'üë§ Usu√°rio' : 'ü§ñ Assistente'}
                        </div>
                        <div style="line-height: 1.4;">${msg.content}</div>
                        <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">
                            üìÖ ${new Date(msg.timestamp).toLocaleString('pt-BR')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentEl.innerHTML = html;
        }

        async function filterHistory() {
            const dateStart = document.getElementById('date-filter').value;
            const dateEnd = document.getElementById('date-filter-end').value;
            const source = document.getElementById('source-filter').value;
            
            try {
                const params = new URLSearchParams();
                if (dateStart) params.append('date_start', dateStart);
                if (dateEnd) params.append('date_end', dateEnd);
                if (source) params.append('source', source);
                
                const response = await fetch(`/api/history/conversations?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    updateHistoryStats(result.stats);
                    displayConversationsList(result.conversations);
                } else {
                    alert('‚ùå Erro ao filtrar hist√≥rico: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erro de filtro: ' + error.message);
            }
        }

        async function exportHistory() {
            const dateStart = document.getElementById('date-filter').value;
            const dateEnd = document.getElementById('date-filter-end').value;
            const source = document.getElementById('source-filter').value;
            
            try {
                const params = new URLSearchParams();
                params.append('format', 'json');
                if (dateStart) params.append('date_start', dateStart);
                if (dateEnd) params.append('date_end', dateEnd);
                if (source) params.append('source', source);
                
                const response = await fetch(`/api/history/export?${params}`);
                const blob = await response.blob();
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversation_history_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Hist√≥rico exportado com sucesso!');
            } catch (error) {
                alert('‚ùå Erro na exporta√ß√£o: ' + error.message);
            }
        }

        async function clearHistory() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar todo o hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/history/clear', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    loadConversationHistory();
                    document.getElementById('conversation-detail').innerHTML = `
                        <div class="no-selection" style="text-align: center; padding: 60px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üóëÔ∏è</div>
                            <div>Hist√≥rico limpo com sucesso</div>
                            <div style="font-size: 12px; margin-top: 5px;">Todas as conversas foram removidas</div>
                        </div>
                    `;
                    alert('‚úÖ Hist√≥rico limpo com sucesso!');
                } else {
                    alert('‚ùå Erro ao limpar hist√≥rico: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erro de limpeza: ' + error.message);
            }
        }
        
        // Initialize Enhanced TTS System
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Enhanced TTS System...');
            
            // Carregar prefer√™ncia TTS padr√£o (Google Flash como padr√£o)
            loadDefaultTTSPreference();
            
            // Load TTS models when page loads
            loadTTSModels();
            
            // Initialize monitoring
            updateMonitoringStatus();
            setInterval(updateMonitoringStatus, 10000); // Update every 10 seconds
            
            // Initialize other components
            try {
                loadConversationHistory();
            } catch (error) {
                console.warn('Could not load conversation history:', error);
            }
            
            console.log('‚úÖ Enhanced TTS System initialized with Google Flash as default');
        });
    </script>
</body>
</html>